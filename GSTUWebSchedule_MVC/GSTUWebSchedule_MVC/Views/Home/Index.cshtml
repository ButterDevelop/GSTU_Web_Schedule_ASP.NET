@model GSTUWebSchedule_MVC.Models.IndexModel
@{
    string TempDataRole = TempData[User.Identity.Name + "_Role"].ToString();
    TempData[User.Identity.Name + "_Role"] = TempDataRole;

    string lang = "ru";
    if (Context.Request.Cookies.ContainsKey("lang")) lang = Context.Request.Cookies["lang"];
    
    ViewData["Title"] = Translate.Tr("Home Page", lang);
    Layout = null;

    int Size = 12;
    if (!Model.Case) Size = 4;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="~/favicon.ico" rel="icon" type="image/ico">
    <title>@ViewData["Title"]</title>
    <!-- Bootstrap -->
    <link href="~/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="~/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="~/css/nprogress.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="~/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="~/css/custom.min.css" rel="stylesheet">

    <style>
        td, th {
            text-align: center !important;
            vertical-align: middle !important;
        }
        [id^='Sum-'] {
            display: none;
        }
        [id^='attestation_'] {
            font-weight: bold;
        }
        /* Bootstrap Modal manual bug fix */
        body {
            padding-right: 0 !important;
        }
    </style>

    <!-- Font Awesome 2 -->
    <link rel="stylesheet" href="~/css/faall.css">
    <!-- Material Design Bootstrap -->
    <link rel="stylesheet" href="~/css/mdb.css">
</head>
<body class="nav-sm">

    <div class="container body">
        <div class="main_container">
            <div class="col-md-3 left_col menu_fixed">
                <div class="left_col scroll-view">
                    <div class="navbar nav_title" style="border: 0;">
                        <a class="site_title" href="/Home/Index"><i class="fa fa-paw"></i></a>
                    </div>
                    <div class="clearfix"></div><br>
                    <!-- sidebar menu -->
                    <div class="main_menu_side hidden-print main_menu" id="sidebar-menu">
                        <div class="menu_section">
                            <h3>@Translate.Tr("General", lang)</h3>
                            <ul class="nav side-menu">

                                <li class="current-page">
                                    <a href="/Home/Index"><i class="fa fa-table"></i>@Translate.Tr("Tables", lang)</a>
                                </li>
                                <li>
                                    <a href="/Home/Manage"><i class="fa fa-server"></i>@Translate.Tr("Tables control", lang)</a>
                                </li>
                                <li>
                                    <a href="/Account/Settings/"><i class="fa fa-cog"></i>@Translate.Tr("Settings", lang)</a>
                                </li>
                                @if (TempDataRole == "Ranged-Creep")
                                {
                                    <li>
                                        <a href="/Account/AdminPanel/"><i class="fas fa-user-shield"></i>@Translate.Tr("Admin Area", lang)</a>
                                    </li>
                                }
                                <li>
                                    <a href="/Account/Logout"><i class="fa fa-step-backward"></i>@Translate.Tr("Log Out", lang)</a>
                                </li>
                            </ul>
                        </div>
                    </div><!-- /sidebar menu -->
                </div>
            </div><!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="">
                            <div class="row x_title">
                                <div class="col-md-12 displ_flex flex_center">
                                    <h3>
                                        @Translate.Tr("Tables Page.", lang)
                                        <font color="1e947b">@Translate.Tr("Username: ", lang)</font>
                                        <font color="808080">@User.Identity.Name</font>,
                                        <font color="3399FF">@Translate.Tr("Current time: ", lang)</font>
                                        <font color="808080">@DateTime.Now</font>.
                                    </h3> <hr>
                                    @if (Model.Case)
                                    {
                                        <!-- First confirmation -->
                                        <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true" id="mi-modal">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                        <h3 class="modal-title text-center" id="myModalLabel">@Translate.Tr("Confirm", lang)</h3>
                                                    </div>
                                                    <div class="modal-body text-center">
                                                        <h4>@Translate.Tr("Are you sure you want to delete this table?", lang)</h4>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-default" id="modal-btn-yes">@Translate.Tr("Yes", lang)</button>
                                                        <button type="button" class="btn btn-primary" id="modal-btn-no">@Translate.Tr("No", lang)</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Second confirmation -->
                                        <div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true" id="mi-modal2">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                                        <h3 class="modal-title text-center" id="myModalLabel2">@Translate.Tr("Confirm. Again.", lang)</h3>
                                                    </div>
                                                    <div class="modal-body text-center">
                                                        <h4>@Translate.Tr("Are you SURE you want to delete this table?", lang)</h4>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-default" id="modal-btn-yes2">@Translate.Tr("YEEES", lang)</button>
                                                        <button type="button" class="btn btn-primary" id="modal-btn-no2">@Translate.Tr("No", lang)</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-danger" id="btn-confirm" type="submit">@Translate.Tr("Delete this table", lang)</button>
                                        <!-- "Delete Table" form -->
                                        <form class="form-horizontal form-label-left input_mask" id="DeleteTableForm" asp-action="DeleteTable" asp-controller="Home" asp-anti-forgery="true">
                                            <input type="hidden" name="Subject" value="@Model.DbTable.ToArray()[0].Subject" required="" />
                                            <input type="hidden" name="Group" value="@Model.DbTable.ToArray()[0].Group" required="" />
                                            <input type="hidden" name="Confirm1" id="Confirm1" value="0" required="" />
                                            <input type="hidden" name="Confirm2" id="Confirm2" value="0" required="" />
                                        </form>
                                        <!-- "Save Changes" form -->
                                        <form class="form-horizontal form-label-left input_mask" onsubmit="return OnSubmitFunction();" asp-action="Index" asp-controller="Home" asp-anti-forgery="true" method="post">
                                            <input type="hidden" id="dataLabs" name="dataLabs" value="">
                                            <input type="hidden" id="dataReports" name="dataReports" value="">
                                            <input type="hidden" id="dataDefences" name="dataDefences" value="">
                                            <input type="hidden" name="dataSubject" value="@Model.DbTable.ToArray()[0].Subject">
                                            <input type="hidden" name="dataGroup" value="@Model.DbTable.ToArray()[0].Group">
                                            <button class="btn btn-success" type="submit">@Translate.Tr("Save changes", lang)</button>
                                        </form>
                                    }
                                </div>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-sm-12 col-md-@Size col-xs-@Size">
                        @if (Model.Case)
                        {<div class="x_panel"><h3><i class="far fa-folder-open ic-w mx-1"></i> @Subjects.constArray[Model.DbTable.ToArray()[0].Subject] &nbsp;<i class="fas fa-angle-right"></i>&nbsp; @Model.DbTable.ToArray()[0].Group </h3></div>}
                        <div class="x_panel">
                            <div class="x_content">
                                @if (!Model.Case)
                                {
                                    <div class="treeview-animated border mx-4 my-4" style="font-size: 14px; margin-right: 15px;">
                                        <ul class="treeview-animated-list mb-3">
                                            <h3 class="pt-3 pl-3">@Translate.Tr("Subjects", lang)</h3>
                                            <hr>
                                            @for (int i = 0; i < Subjects.size; i++)
                                            {
                                                int count = Model.DbTable.Count(m => m.Subject == i);
                                                <li class="treeview-animated-items">
                                                    <a class="closed">
                                                        <i class="fas fa-angle-right"></i>
                                                        <span>
                                                            <i class="far fa-folder-open ic-w mx-1"></i> @if (count > 0)
                                                            {<b>@Subjects.constArray[i]</b> }
                                                        else
                                                        { @Subjects.constArray[i]}
                                                        </span>
                                                    </a>
                                                    @if (count > 0)
                                                    {
                                                        <ul class="nested">
                                                            @foreach (var b in Model.DbTable)
                                                                if (b.Subject == i)
                                                                {
                                                                    <li>
                                                                        <a href="/?subject=@i&group=@b.Group" class="treeview-animated-element"><i class="fas fa-table ic-w mr-1"></i> @b.Group</a>
                                                                    </li>
                                                                }
                                                        </ul>
                                                    }
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                                else
                                {
                                    var MyModel = Model.DbTable.ToArray()[0];

                                    var Students = MyModel.Students.Split(' ', StringSplitOptions.RemoveEmptyEntries).ToArray();
                                    for (int i = 0; i < Students.Length; i++) Students[i] = System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(Students[i]));

                                    var Labs = MyModel.Labs.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                                    var Reports = MyModel.Reports.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                                    var Defences = MyModel.Defences.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                                    <table class="table table-striped table-bordered" id="datatable">
                                        <thead>
                                            <tr>
                                                <th>№</th>
                                                <th>@Translate.Tr("Full name", lang)</th>
                                                <th>@Translate.Tr("Attestation", lang)</th>
                                                @for (int i = 1; i <= MyModel.NumberOfLabs; i++)
                                                {
                                                    <th>@Translate.Tr("Lab.", lang) №@i</th>
                                                }
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{
                                                if (Model != null)
                                                    for (int i = 0; i < Students.Length; i++)
                                                    {
                                                        <tr>
                                                            <td><b>@(i+1).</b></td>
                                                            <td><b>@Students[i]</b></td>
                                                            <td><span id="attestation_@i">@i</span></td>
                                                            @for (int j = 0; j < MyModel.NumberOfLabs; j++)
                                                            {
                                                                int kol = 0;
                                                                string id1 = "Lab-" + i.ToString() + "_" + j.ToString(), id2 = "Report-" + i.ToString() + "_" + j.ToString(), id3 = "Defence-" + i.ToString() + "_" + j.ToString(),
                                                                    checked1 = Labs[i][j] == '1' ? "checked" : "", checked2 = Reports[i][j] == '1' ? "checked" : "", checked3 = Defences[i][j] == '1' ? "checked" : "",
                                                                    Sum = "Sum-" + i.ToString() + "_" + j.ToString();

                                                                if (checked1 == "checked") kol++; if (checked2 == "checked") kol++; if (checked3 == "checked") kol++;
                                                                <td>
                                                                    <span id="Sum-@(i)_@(j)">@kol</span>
                                                                    <div class="form-check form-check-inline">
                                                                        <input class="form-check-input" type="checkbox" id="@id1" onchange="CheckBoxClicked(this.id)" @checked1 />
                                                                        <label class="form-check-label" for="@id1">@Translate.Tr("Lab", lang)</label>
                                                                    </div>
                                                                    <div class="form-check form-check-inline">
                                                                        <input class="form-check-input" type="checkbox" id="@id2" onchange="CheckBoxClicked(this.id)" @checked2 />
                                                                        <label class="form-check-label" for="@id2">@Translate.Tr("Report", lang)</label>
                                                                    </div>
                                                                    <div class="form-check form-check-inline">
                                                                        <input class="form-check-input" type="checkbox" id="@id3" onchange="CheckBoxClicked(this.id)" @checked3 />
                                                                        <label class="form-check-label" for="@id3">@Translate.Tr("Defence", lang)</label>
                                                                    </div>
                                                                </td>
                                                            }
                                                        </tr>
                                                    }
                                            }
                                        </tbody>
                                    </table>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- /page content -->
        </div>
    </div>
    <!-- jQuery -->
    <script src="~/js/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="~/js/bootstrap.min.js"></script>
    <!-- NProgress -->
    <script src="~/js/nprogress.js"></script>
    <!-- Datatables -->
    <script src="~/js/jquery.dataTables.min.js"></script>
    <script src="~/js/dataTables.bootstrap.min.js"></script>
    <script src="~/js/custom.js"></script>

    <!-- Bootstrap tooltips -->
    <script src="~/js/popper.min.js"></script>
    <!-- MDB core JavaScript -->
    <script src="~/js/mdb.js"></script>
    <script>
        $(function () {
            $('.treeview-animated').mdbTreeview();
        });
    </script>

    <script>
        window.addEventListener("pageshow", function (event) {
            var historyTraversal = event.persisted ||
                (typeof window.performance != "undefined" &&
                    window.performance.navigation.type === 2);
            if (historyTraversal) {
                //Handle page restore.
                window.location.reload();
            }
        });

        @if (Model.Case)
        {
            var Labs = Model.DbTable.ToArray()[0].Labs.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            var Reports = Model.DbTable.ToArray()[0].Reports.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            var Defences = Model.DbTable.ToArray()[0].Defences.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            <text>
                $(document).ready(function () {
                    //Init Attestation
                    for (let j = 0; j @Html.Raw("<") @Model.DbTable.ToArray()[0].Students.Split(' ', StringSplitOptions.RemoveEmptyEntries).ToArray().Length; j++) {
                        var att = 0;
                        for (let i = 0; i @Html.Raw("<") @Model.DbTable.ToArray()[0].NumberOfLabs; i++)
                            if (document.getElementById("Lab-" + j + "_" + i).checked && document.getElementById("Report-" + j + "_" + i).checked && document.getElementById("Defence-" + j + "_" + i).checked) att++;

                        var myfloat = (att * 10 / @Model.DbTable.ToArray()[0].NumberOfLabs).toFixed(3);
                        var element = document.getElementById("attestation_" + j);
                        element.innerHTML = myfloat;
                        if (myfloat == 0) element.style.color = "red"; else
                        if (myfloat @Html.Raw("<") 4) element.style.color = "darkred"; else
                        if (myfloat @Html.Raw("<") 6) element.style.color = "orange"; else
                        if (myfloat @Html.Raw("<") 8) element.style.color = "yellow"; else
                        if (myfloat @Html.Raw("<") 10) element.style.color = "green"; else element.style.color = "blue";
                    }
                    $("#datatable").DataTable().rows().invalidate();

                var modalConfirm2 = function (callback) {
                    $("#modal-btn-yes2").on("click", function () {
                        $("#mi-modal2").modal('hide');
                        callback(true);
                    });
                    $("#modal-btn-no2").on("click", function () {
                        $("#mi-modal2").modal('hide');
                        callback(false);
                    });
                };
                modalConfirm2(function (confirm) {
                    if (confirm) {
                        document.getElementById('Confirm2').value = "1";
                        document.getElementById('DeleteTableForm').submit();
                    } else {
                        document.getElementById('Confirm1').value = "0";
                        document.getElementById('Confirm2').value = "0";
                    }
                });

                var modalConfirm = function (callback) {
                    $("#btn-confirm").on("click", function () {
                        $("#mi-modal").modal('show');
                    });
                    $("#modal-btn-yes").on("click", function () {
                        $("#mi-modal").modal('hide');
                        callback(true);
                    });
                    $("#modal-btn-no").on("click", function () {
                        $("#mi-modal").modal('hide');
                        callback(false);
                    });
                };
                modalConfirm(function (confirm) {
                    if (confirm) {
                        document.getElementById('Confirm1').value = "1";
                        $("#mi-modal2").modal('show');
                    } else {
                        document.getElementById('Confirm1').value = "0";
                    }
                });
            });
            let dataLabs = [@for (int i = 0; i < Labs.Length - 1; i++) { <text>@Html.Raw("\"")@Labs[i]@Html.Raw("\", ")</text> } @{<text>@Html.Raw("\"")@Labs[Labs.Length - 1]@Html.Raw("\"")</text>}];
            let dataReports = [@for (int i = 0; i < Reports.Length - 1; i++) { <text>@Html.Raw("\"")@Reports[i]@Html.Raw("\", ")</text> } @{<text>@Html.Raw("\"")@Reports[Reports.Length - 1]@Html.Raw("\"")</text>}];
            let dataDefences = [@for (int i = 0; i < Defences.Length - 1; i++) { <text>@Html.Raw("\"")@Defences[i]@Html.Raw("\", ")</text> } @{<text>@Html.Raw("\"")@Defences[Defences.Length - 1]@Html.Raw("\"")</text>}];
            let oldLabs = [@for (int i = 0; i < Labs.Length - 1; i++) { <text>@Html.Raw("\"")@Labs[i]@Html.Raw("\", ")</text> } @{<text>@Html.Raw("\"")@Labs[Labs.Length - 1]@Html.Raw("\"")</text>}];
            let oldReports = [@for (int i = 0; i < Reports.Length - 1; i++) { <text>@Html.Raw("\"")@Reports[i]@Html.Raw("\", ")</text> } @{<text>@Html.Raw("\"")@Reports[Reports.Length - 1]@Html.Raw("\"")</text>}];
            let oldDefences = [@for (int i = 0; i < Defences.Length - 1; i++) { <text>@Html.Raw("\"")@Defences[i]@Html.Raw("\", ")</text> } @{<text>@Html.Raw("\"")@Defences[Defences.Length - 1]@Html.Raw("\"")</text>}];
            function CheckBoxClicked(id) {
                const words = id.split('-');
                var kol = 0;

                if (document.getElementById("Lab-" + words[1]).checked) kol++;
                if (document.getElementById("Report-" + words[1]).checked) kol++;
                if (document.getElementById("Defence-" + words[1]).checked) kol++;

                var index1 = parseInt(words[1].split('_')[0]);
                var index2 = parseInt(words[1].split('_')[1]);

                dataLabs[index1] = dataLabs[index1].split('');
                dataLabs[index1][index2] = document.getElementById("Lab-" + words[1]).checked ? '1' : '0';
                dataLabs[index1] = dataLabs[index1].join('');

                dataReports[index1] = dataReports[index1].split('');
                dataReports[index1][index2] = document.getElementById("Report-" + words[1]).checked ? '1' : '0';
                dataReports[index1] = dataReports[index1].join('');

                dataDefences[index1] = dataDefences[index1].split('');
                dataDefences[index1][index2] = document.getElementById("Defence-" + words[1]).checked ? '1' : '0';
                dataDefences[index1] = dataDefences[index1].join('');

                var att = 0;
                for (let i = 0; i @Html.Raw("<") @Model.DbTable.ToArray()[0].NumberOfLabs; i++)
                    if (document.getElementById("Lab-" + index1 + "_" + i).checked && document.getElementById("Report-" + index1 + "_" + i).checked && document.getElementById("Defence-" + index1 + "_" + i).checked) att++;

                var myfloat = (att * 10 / @Model.DbTable.ToArray()[0].NumberOfLabs).toFixed(3);
                var element = document.getElementById("attestation_" + index1);
                element.innerHTML = myfloat;
                if (myfloat == 0) element.style.color = "red"; else
                if (myfloat @Html.Raw("<") 4) element.style.color = "darkred"; else
                if (myfloat @Html.Raw("<") 6) element.style.color = "darkorange"; else
                if (myfloat @Html.Raw("<") 8) element.style.color = "darkgoldenrod"; else
                if (myfloat @Html.Raw("<") 10) element.style.color = "green"; else element.style.color = "blue";

                document.getElementById("Sum-" + words[1]).innerHTML = kol;
                $("#datatable").DataTable().rows().invalidate();
            }

            function OnSubmitFunction() {
                let flagLabs = true, flagReports = true, flagDefences = true;
                for (let i = 0; i @Html.Raw("<") @Model.DbTable.ToArray()[0].Students.Split(' ', StringSplitOptions.RemoveEmptyEntries).ToArray().Length; i++) {
                    if (oldLabs[i] != dataLabs[i]) flagLabs = false;
                    if (oldReports[i] != dataReports[i]) flagReports = false;
                    if (oldDefences[i] != dataDefences[i]) flagDefences = false;
                }
                if (flagLabs && flagReports && flagDefences) return false;

                var stringLabs = "", stringReports = "", stringDefences = "";
                for (let i = 0; i @Html.Raw("<") @Model.DbTable.ToArray()[0].Students.Split(' ', StringSplitOptions.RemoveEmptyEntries).ToArray().Length; i++) {
                    stringLabs += dataLabs[i];
                    stringReports += dataReports[i];
                    stringDefences += dataDefences[i];
                    stringLabs += " "; stringReports += " "; stringDefences += " ";
                }
                document.getElementById("dataLabs").value = stringLabs.substring(0, stringLabs.length - 1);
                document.getElementById("dataReports").value = stringReports.substring(0, stringReports.length - 1);
                document.getElementById("dataDefences").value = stringDefences.substring(0, stringDefences.length - 1);
                return true;
            }
            </text>
        }
    </script>
</body>
</html>
