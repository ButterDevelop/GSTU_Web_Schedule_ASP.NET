@model GSTUWebSchedule_MVC.Models.IndexModel
@{
    ViewData["Title"] = "Home Page";
    Layout = null;

    int Size = 12;
    if (!Model.Case) Size = 4;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <link href="favicon.ico" rel="icon" type="image/ico">
    <title>@ViewData["Title"]</title>
    <!-- Bootstrap -->
    <link href="~/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="~/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="~/css/nprogress.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="~/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="~/css/custom.min.css" rel="stylesheet">

    <script>
        window.addEventListener("pageshow", function (event) {
            var historyTraversal = event.persisted ||
                (typeof window.performance != "undefined" &&
                    window.performance.navigation.type === 2);
            if (historyTraversal) {
                //Handle page restore.
                window.location.reload();
            }
        });

        @if (Model.Case)
        {
            var Labs = Model.DbTable.ToArray()[0].Labs.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            var Reports = Model.DbTable.ToArray()[0].Reports.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            var Defences = Model.DbTable.ToArray()[0].Defences.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            <text>
            let dataLabs = [@for (int i = 0; i < Labs.Length - 1; i++) { <text>@Html.Raw("\"")@Labs[i]@Html.Raw("\", ")</text> } @{<text>@Html.Raw("\"")@Labs[Labs.Length - 1]@Html.Raw("\"")</text>}];
            let dataReports = [@for (int i = 0; i < Reports.Length - 1; i++) { <text>@Html.Raw("\"")@Reports[i]@Html.Raw("\", ")</text> } @{<text>@Html.Raw("\"")@Reports[Reports.Length - 1]@Html.Raw("\"")</text>}];
            let dataDefences = [@for (int i = 0; i < Defences.Length - 1; i++) { <text>@Html.Raw("\"")@Defences[i]@Html.Raw("\", ")</text> } @{<text>@Html.Raw("\"")@Defences[Defences.Length - 1]@Html.Raw("\"")</text>}];
            function CheckBoxClicked(id) {
                const words = id.split('-');
                var kol = 0;

                if (document.getElementById("Lab-" + words[1]).checked) kol++;
                if (document.getElementById("Report-" + words[1]).checked) kol++;
                if (document.getElementById("Defence-" + words[1]).checked) kol++;

                var index1 = parseInt(words[1].split('_')[0]);
                var index2 = parseInt(words[1].split('_')[1]);

                dataLabs[index1][index2] = document.getElementById("Lab-" + words[1]).checked ? "1" : "0";
                dataReports[index1][index2] = document.getElementById("Report-" + words[1]).checked ? "1" : "0";
                dataDefences[index1][index2] = document.getElementById("Defence-" + words[1]).checked ? "1" : "0";

                document.getElementById("Sum-" + words[1]).innerHTML = kol;
            }

            function OnSubmitFunction() {
                var stringLabs = "", stringReports = "", stringDefences = "";
                for (let i = 0; i @Html.Raw("<") @Model.DbTable.ToArray()[0].Students.Split(' ', StringSplitOptions.RemoveEmptyEntries).ToArray().Length; i++) {
                    //for (let j = 0; j @Html.Raw("<") @Model.DbTable.ToArray()[0].NumberOfLabs; j++) {
                        /*dataLabs += document.getElementById("Lab-" + i + "_" + j).checked ? "1" : "0";
                        dataReports += document.getElementById("Report-" + i + "_" + j).checked ? "1" : "0";
                        dataDefences += document.getElementById("Defence-" + i + "_" + j).checked ? "1" : "0";*/
                        stringLabs += dataLabs[i];
                        stringReports += dataReports[i];
                        stringDefences += dataDefences[i];
                    //}
                    stringLabs += " "; stringReports += " "; stringDefences += " ";
                }
                document.getElementById("dataLabs").value = stringLabs.substring(0, stringLabs.length - 1);
                document.getElementById("dataReports").value = stringReports.substring(0, stringReports.length - 1);
                document.getElementById("dataDefences").value = stringDefences.substring(0, stringDefences.length - 1);
                return true;
            }
            </text>
        }
    </script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="~/css/faall.css">
    <!-- Material Design Bootstrap -->
    <link rel="stylesheet" href="~/css/mdb.css">
</head>
<body class="nav-sm">

    <div class="container body">
        <div class="main_container">
            <div class="col-md-3 left_col menu_fixed">
                <div class="left_col scroll-view">
                    <div class="navbar nav_title" style="border: 0;">
                        <a class="site_title" href="/Home/Index"><i class="fa fa-paw"></i> <span>Admin Panel</span></a>
                    </div>
                    <div class="clearfix"></div><br>
                    <!-- sidebar menu -->
                    <div class="main_menu_side hidden-print main_menu" id="sidebar-menu">
                        <div class="menu_section">
                            <h3>General</h3>
                            <ul class="nav side-menu">

                                <li class="current-page">
                                    <a href="/Home/Index"><i class="fa fa-table"></i>Logs</a>
                                </li>
                                <li>
                                    <a href="/Home/Manage"><i class="fa fa-server"></i>Tables control</a>
                                </li>
                                <li>
                                    <a href="settings.php"><i class="fa fa-cog"></i>Settings</a>
                                </li>
                                <li>
                                    <a href="/Account/Logout"><i class="fa fa-step-backward"></i>Log Out</a>
                                </li>
                            </ul>
                        </div>
                    </div><!-- /sidebar menu -->
                </div>
            </div><!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="">
                            <div class="row x_title">
                                <div class="col-md-12 displ_flex flex_center">
                                    <h3>
                                        Tables Page.
                                        <font color="3399FF">Current time: </font>
                                        <font color="808080">@DateTime.Now</font>.
                                    </h3> <hr>
                                    @if (Model.Case)
                                    { 
                                        <form class="form-horizontal form-label-left input_mask" onsubmit="return OnSubmitFunction();" asp-action="SaveChanges" asp-controller="Home" asp-anti-forgery="true" method="post">
                                            <input type="hidden" id="dataLabs" asp-for="dataLabs" value="">
                                            <input type="hidden" id="dataReports" asp-for="dataReports" value="">
                                            <input type="hidden" id="dataDefences" asp-for="dataDefences" value="">
                                            <input type="hidden" asp-for="dataSubject" value="@Model.DbTable.ToArray()[0].Subject">
                                            <input type="hidden" asp-for="dataGroup" value="@Model.DbTable.ToArray()[0].Group">
                                            <button class="btn btn-success" type="submit">Save changes</button>
                                        </form>
                                    }
                                </div>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-@Size col-sm-@Size col-xs-@Size">
                        @if (Model.Case) { <div class="x_panel"><h3><i class="far fa-folder-open ic-w mx-1"></i> @Subjects.constArray[Model.DbTable.ToArray()[0].Subject] &nbsp;<i class="fas fa-angle-right"></i>&nbsp; @Model.DbTable.ToArray()[0].Group </h3></div> }
                        <div class="x_panel">
                            <div class="x_content">
                                @if (!Model.Case)
                                {
                                    <div class="treeview-animated border mx-4 my-4" style="font-size: 14px; margin-right: 15px;">
                                        <ul class="treeview-animated-list mb-3">
                                            <h3 class="pt-3 pl-3">Subjects</h3>
                                            <hr>
                                            @for (int i = 0; i < Subjects.size; i++)
                                            {
                                                int count = Model.DbTable.Count(m => m.Subject == i);
                                                <li class="treeview-animated-items">
                                                    <a class="closed">
                                                        <i class="fas fa-angle-right"></i>
                                                        <span><i class="far fa-folder-open ic-w mx-1"></i> @if (count > 0)
                                                        { <b>@Subjects.constArray[i]</b> }
                                                        else
                                                        {  @Subjects.constArray[i] } </span>
                                                    </a>
                                                    @if (count > 0)
                                                    {
                                                        <ul class="nested">
                                                            @foreach (var b in Model.DbTable)
                                                                if (b.Subject == i)
                                                                {
                                                                    <li>
                                                                        <a href="/?subject=@i&group=@b.Group" class="treeview-animated-element"><i class="fas fa-table ic-w mr-1"></i> @b.Group</a>
                                                                    </li>
                                                                }
                                                        </ul>
                                                    }
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                                else
                                {
                                    var MyModel = Model.DbTable.ToArray()[0];

                                    var Students = MyModel.Students.Split(' ', StringSplitOptions.RemoveEmptyEntries).ToArray();
                                    for (int i = 0; i < Students.Length; i++) Students[i] = System.Text.Encoding.UTF8.GetString(Convert.FromBase64String(Students[i]));

                                    var Labs = MyModel.Labs.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                                    var Reports = MyModel.Reports.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                                    var Defences = MyModel.Defences.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                                    <table class="table table-striped table-bordered" id="datatable">
                                        <thead>
                                            <tr>
                                                <th style="text-align: center; vertical-align: middle;">№</th>
                                                <th style="text-align: center; vertical-align: middle;">Full name</th>
                                                @for (int i = 1; i <= MyModel.NumberOfLabs; i++)
                                                {
                                                    <th style="text-align: center; vertical-align: middle;">Lab. №@i</th>
                                                }
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{
                                                if (Model != null)
                                                    for (int i = 0; i < Students.Length; i++)
                                                    {
                                                        <tr>
                                                            <td style="text-align: center; vertical-align: middle;"><b>@(i+1).</b></td>
                                                            <td style="text-align: center; vertical-align: middle;"><b>@Students[i]</b></td>
                                                            @for (int j = 0; j < MyModel.NumberOfLabs; j++)
                                                            {
                                                                <td>
                                                                    @{
                                                                        int kol = 0;
                                                                        string id1 = "Lab-" + i.ToString() + "_" + j.ToString(), id2 = "Report-" + i.ToString() + "_" + j.ToString(), id3 = "Defence-" + i.ToString() + "_" + j.ToString(),
                                                                            checked1 = Labs[i][j] == '1' ? "checked" : "", checked2 = Reports[i][j] == '1' ? "checked" : "", checked3 = Defences[i][j] == '1' ? "checked" : "",
                                                                            Sum = "Sum-" + i.ToString() + "_" + j.ToString();

                                                                        if (checked1 == "checked") kol++; if (checked2 == "checked") kol++; if (checked3 == "checked") kol++;
                                                                    }
                                                                    <span style="color: transparent; display: none;" id="Sum-@(i)_@(j)">kol</span>
                                                                    <div class="form-check form-check-inline">
                                                                        <input class="form-check-input" type="checkbox" id="@id1" onchange="CheckBoxClicked(this.id)" @checked1 />
                                                                        <label class="form-check-label" for="@id1">Lab</label>
                                                                    </div>
                                                                    <div class="form-check form-check-inline">
                                                                        <input class="form-check-input" type="checkbox" id="@id2" onchange="CheckBoxClicked(this.id)" @checked2 />
                                                                        <label class="form-check-label" for="@id2">Report</label>
                                                                    </div>
                                                                    <div class="form-check form-check-inline">
                                                                        <input class="form-check-input" type="checkbox" id="@id3" onchange="CheckBoxClicked(this.id)" @checked3 />
                                                                        <label class="form-check-label" for="@id3">Defence</label>
                                                                    </div>
                                                                </td>
                                                            }
                                                        </tr>
                                                    }
                                            }
                                        </tbody>
                                    </table>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- /page content -->
        </div>
    </div>
    <!-- jQuery -->
    <script src="~/js/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="~/js/bootstrap.min.js"></script>
    <!-- NProgress -->
    <script src="~/js/nprogress.js"></script>
    <!-- Datatables -->
    <script src="~/js/jquery.dataTables.min.js"></script>
    <script src="~/js/dataTables.bootstrap.min.js"></script>
    <script src="~/js/custom.js"></script>

    <!-- Bootstrap tooltips -->
    <script src="~/js/popper.min.js"></script>
    <!-- MDB core JavaScript -->
    <script src="~/js/mdb.js"></script>
    <script>
        $(function () {
            $('.treeview-animated').mdbTreeview();
        });
    </script>
</body>
</html>
